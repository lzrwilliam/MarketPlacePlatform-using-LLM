{% extends 'base.html' %}

{% block title %}Adăugare Produs{% endblock %}
{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">Adaugă un Produs Nou</h1>
    
    <form method="POST" action="{{ url_for('add_product') }}" class="p-4 bg-white shadow rounded" id="productForm">
        <!-- Nume Produs -->
        <div class="mb-3">
            <label for="name" class="form-label">Nume Produs:</label>
            <input type="text" class="form-control" id="name" name="name" required>
        </div>
        
        <!-- Buton pentru generarea categoriei -->
        <button type="button" class="btn btn-warning mb-3" id="suggestCategoryBtn">Sugerează Categoria</button>
        <p><strong>Categorie Recomandată:</strong> <span id="suggestedCategory">Nicio categorie sugerată</span></p>
        
        <!-- Dropdown Categorie -->
        <div class="mb-3">
            <label for="category" class="form-label">Categorie:</label>
            <select class="form-control" id="category" name="category" required>
                {% for category in categories %}
                <option value="{{ category }}">{{ category }}</option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Preț Produs -->
        <div class="mb-3">
            <label for="price" class="form-label">Preț (RON):</label>
            <input type="number" class="form-control" id="price" name="price" required step="0.01">
        </div>

        <!-- Buton pentru generarea descrierii -->
        <button type="button" class="btn btn-secondary mb-3" id="generateBtn">Generează Descriere</button>

        <!-- Descrierea Generată -->
        <div class="mb-3">
            <label for="description" class="form-label">Descriere Generată:</label>
            <textarea class="form-control" id="description" name="description" rows="4" readonly></textarea>
        </div>
        
        <!-- Buton de Adăugare Produs -->
        <button type="submit" class="btn btn-primary w-100">Adaugă Produs</button>
        <a href="/" class="btn btn-secondary w-100 mt-3">Înapoi la Produse</a>
    </form>
</div>
{% endblock %}

<!-- ✅ Blocul de scripturi mutat în blocul corect -->
{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log("✅ JavaScript încărcat complet!");

        document.getElementById('suggestCategoryBtn').addEventListener('click', async function () {
            const name = document.getElementById('name').value.trim();
            console.log("Sugestie categorie apăsată!", name);

            if (!name) {
                alert("Introduceți numele produsului înainte de a sugera categoria!");
                return;
            }

            try {
                const response = await fetch('/suggest_category', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({name: name})
                });
                const data = await response.json();
                console.log("Răspuns server:", data);
                if (data.suggested_category) {
                    document.getElementById('suggestedCategory').textContent = data.suggested_category;
                    document.getElementById('category').value = data.suggested_category;
                } else {
                    alert(data.error);
                }
            } catch (error) {
                console.error("❌ Eroare la generarea categoriei:", error);
            }
        });

        document.getElementById('generateBtn').addEventListener('click', async function () {
            const name = document.getElementById('name').value.trim();
            const category = document.getElementById('category').value.trim();
            console.log("Generare descriere apăsată!", name, category);

            if (!name || !category) {
                alert("Completați numele și categoria înainte de a genera descrierea!");
                return;
            }

            try {
                const response = await fetch('/generate_description', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({name: name, category: category})
                });
                const data = await response.json();
                console.log("Răspuns server pentru descriere:", data);
                if (data.description) {
                    document.getElementById('description').value = data.description;
                } else {
                    alert(data.error);
                }
            } catch (error) {
                console.error("❌ Eroare la generarea descrierii:", error);
            }
        });
    });
</script>
{% endblock %}
